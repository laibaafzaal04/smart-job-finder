<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload CV - Smart Job Finder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=EB+Garamond:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="assets/style.css">
    <style>
        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }

        .upload-area {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            background-color: #f8f9fa !important;
            border-color: #17A2B8 !important;
        }

        .upload-area.dragover {
            background-color: #e9ecef !important;
            border-color: #17A2B8 !important;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-light bg-white shadow-sm px-4 py-3">
        <a class="navbar-brand fw-bold" href="index.html">SmartJobFinder</a>
    </nav>

    <div class="container d-flex justify-content-center align-items-center min-vh-100">
        <div class="card upload-cv-card shadow-lg p-5" style="max-width: 700px; width: 100%;">
            <h2 class="text-center mb-4 fw-bold" style="font-family: 'Playfair Display';" id="pageTitle">Complete Your
                Profile</h2>
            <p class="text-center text-muted mb-4" id="pageSubtitle">Upload your CV and add your personal information to
                get personalized job recommendations</p>

            <form id="uploadCVForm">
                <!-- Personal Information Section -->
                <div class="mb-4">
                    <h5 class="fw-bold mb-3 border-bottom pb-2">Personal Information</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Full Name *</label>
                                <input type="text" class="form-control rounded-pill input-field" id="fullName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Email *</label>
                                <input type="email" class="form-control rounded-pill input-field" id="email" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Phone Number *</label>
                                <input type="tel" class="form-control rounded-pill input-field" id="phone" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Location *</label>
                                <input type="text" class="form-control rounded-pill input-field" id="location"
                                    placeholder="City, Country" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Education Level</label>
                                <select class="form-select rounded-pill" id="education">
                                    <option value="">Select education level</option>
                                    <option value="high_school">High School</option>
                                    <option value="associate">Associate Degree</option>
                                    <option value="bachelor">Bachelor's Degree</option>
                                    <option value="master">Master's Degree</option>
                                    <option value="phd">PhD</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Experience Level</label>
                                <select class="form-select rounded-pill" id="experience">
                                    <option value="">Select your experience level</option>
                                    <option value="entry">Entry Level (0-2 years)</option>
                                    <option value="mid">Mid Level (2-5 years)</option>
                                    <option value="senior">Senior Level (5+ years)</option>
                                    <option value="executive">Executive Level</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Professional Headline</label>
                        <input type="text" class="form-control rounded-pill input-field" id="headline"
                            placeholder="e.g., Frontend Developer, Marketing Specialist">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">About Me</label>
                        <textarea class="form-control" id="about" rows="3"
                            placeholder="Write a brief description about yourself, your career goals, and what you're looking for..."></textarea>
                    </div>
                </div>

                <!-- Skills Section -->
                <div class="mb-4">
                    <h5 class="fw-bold mb-3 border-bottom pb-2">Skills & Expertise</h5>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Skills (comma separated)</label>
                        <input type="text" class="form-control rounded-pill input-field" id="skills"
                            placeholder="e.g., JavaScript, React, Photoshop, Marketing">
                        <div class="form-text">Separate each skill with a comma</div>
                    </div>
                </div>

                <!-- CV Upload Section -->
                <div class="mb-4">
                    <h5 class="fw-bold mb-3 border-bottom pb-2">CV/Resume</h5>
                    <div class="text-center">
                        <div class="upload-area p-5 border rounded-4 bg-light" id="uploadArea">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            <h5>Drag & Drop your CV here</h5>
                            <p class="text-muted">or</p>
                            <input type="file" id="cvFile" accept=".pdf,.doc,.docx" style="display: none;">
                            <button type="button" class="btn btn-outline-primary rounded-pill"
                                onclick="document.getElementById('cvFile').click()">
                                Browse Files
                            </button>
                            <p class="small text-muted mt-2">Supported formats: PDF, DOC, DOCX (Max 5MB)</p>
                        </div>
                        <div id="fileName" class="mt-3 text-success fw-bold" style="display: none;"></div>
                        <div class="error-message" id="fileError"></div>
                    </div>
                </div>

                <div class="d-flex gap-3">
                    <button type="submit" class="btn btn-gradient rounded-pill flex-fill py-2"
                        id="submitButton">Complete Profile & Continue to Dashboard</button>
                    <button type="button" class="btn btn-outline-primary rounded-pill" onclick="skipUpload()"
                        id="skipButton">Skip for now</button>
                </div>
            </form>
        </div>
    </div>

    <script>
       const API_BASE_URL = "http://127.0.0.1:8000";
        // Check if user is logged in or is a new user
        window.addEventListener('load', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const isNewUser = urlParams.get('new_user') === 'true';
            const isEdit = urlParams.get('edit') === 'true';

            if (isNewUser) {
                // New user flow - use temp token
                const tempToken = localStorage.getItem('temp_access_token');
                const tempUser = JSON.parse(localStorage.getItem('temp_user') || '{}');

                if (!tempToken || !tempUser) {
                    window.location.href = 'login.html';
                    return;
                }

                // Set up for new user
                document.getElementById('pageTitle').textContent = 'Complete Your Profile';
                document.getElementById('pageSubtitle').textContent = 'Please complete your profile to get started';
                document.getElementById('skipButton').style.display = 'none';

                // Pre-fill with user data from registration
                if (tempUser.email) {
                    document.getElementById('email').value = tempUser.email;
                    document.getElementById('email').readOnly = true;
                }

                if (tempUser.full_name) {
                    document.getElementById('fullName').value = tempUser.full_name;
                }

                // Don't load existing profile data for new users

            } else if (isEdit) {
                // Existing edit flow
                document.getElementById('pageTitle').textContent = 'Edit Your Profile';
                document.getElementById('pageSubtitle').textContent = 'Update your personal information and CV';
                document.getElementById('submitButton').textContent = 'Update Profile';
                document.getElementById('skipButton').style.display = 'none';

                // Check for regular login
                const isLoggedIn = localStorage.getItem('isLoggedIn');
                if (!isLoggedIn) {
                    window.location.href = 'login.html';
                    return;
                }

                // Load existing user data if available (existing code)
                const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const userEmail = userData.email || localStorage.getItem('userEmail');

                // Get the most complete user data
                let profileData = userData;
                if (userEmail && users[userEmail]) {
                    profileData = { ...profileData, ...users[userEmail] };
                }

                // Populate form with existing data
                if (profileData.fullName) {
                    document.getElementById('fullName').value = profileData.fullName;
                }

                if (profileData.email) {
                    document.getElementById('email').value = profileData.email;
                    document.getElementById('email').readOnly = true;
                }

                if (profileData.phone) {
                    document.getElementById('phone').value = profileData.phone;
                }

                if (profileData.location) {
                    document.getElementById('location').value = profileData.location;
                }

                if (profileData.education) {
                    document.getElementById('education').value = profileData.education;
                }

                if (profileData.experience) {
                    document.getElementById('experience').value = profileData.experience;
                }

                if (profileData.headline) {
                    document.getElementById('headline').value = profileData.headline;
                }

                if (profileData.about) {
                    document.getElementById('about').value = profileData.about;
                }

                if (profileData.skills && Array.isArray(profileData.skills)) {
                    document.getElementById('skills').value = profileData.skills.join(', ');
                }

            } else {
                // Regular flow - redirect to login if not logged in
                const isLoggedIn = localStorage.getItem('isLoggedIn');
                if (!isLoggedIn) {
                    window.location.href = 'login.html';
                    return;
                }

                // Check if user is admin
                const isAdmin = localStorage.getItem('isAdmin') === 'true';
                if (isAdmin) {
                    window.location.href = 'admin-dashboard.html';
                    return;
                }

                // Check if profile is already completed
                const userData = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (userData.profileCompleted) {
                    window.location.href = 'profile.html';
                    return;
                }

                // Load existing user data if available (for existing users completing profile)
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const userEmail = userData.email || localStorage.getItem('userEmail');

                // Get the most complete user data
                let profileData = userData;
                if (userEmail && users[userEmail]) {
                    profileData = { ...profileData, ...users[userEmail] };
                }

                // Populate form with existing data
                if (profileData.fullName) {
                    document.getElementById('fullName').value = profileData.fullName;
                }

                if (profileData.email) {
                    document.getElementById('email').value = profileData.email;
                    document.getElementById('email').readOnly = true;
                }

                if (profileData.phone) {
                    document.getElementById('phone').value = profileData.phone;
                }

                if (profileData.location) {
                    document.getElementById('location').value = profileData.location;
                }

                if (profileData.education) {
                    document.getElementById('education').value = profileData.education;
                }

                if (profileData.experience) {
                    document.getElementById('experience').value = profileData.experience;
                }

                if (profileData.headline) {
                    document.getElementById('headline').value = profileData.headline;
                }

                if (profileData.about) {
                    document.getElementById('about').value = profileData.about;
                }

                if (profileData.skills && Array.isArray(profileData.skills)) {
                    document.getElementById('skills').value = profileData.skills.join(', ');
                }
            }
        });

        // File upload handling
        document.getElementById('cvFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            handleFileSelection(file);
        });

        // Click on upload area to trigger file input
        document.getElementById('uploadArea').addEventListener('click', function () {
            document.getElementById('cvFile').click();
        });

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', function (e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function (e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function (e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFileSelection(file);
            }
        });

        function handleFileSelection(file) {
            if (file) {
                // Check file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    showFileError('File size must be less than 5MB');
                    document.getElementById('cvFile').value = '';
                    return;
                }

                // Check file type
                const allowedTypes = [
                    'application/pdf',
                    'application/msword',
                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                ];
                if (!allowedTypes.includes(file.type)) {
                    showFileError('Please upload a PDF, DOC, or DOCX file');
                    document.getElementById('cvFile').value = '';
                    return;
                }

                document.getElementById('fileName').textContent = `Selected: ${file.name}`;
                document.getElementById('fileName').style.display = 'block';
                hideFileError();
            }
        }

        function showFileError(message) {
            const fileError = document.getElementById('fileError');
            fileError.textContent = message;
            fileError.style.display = 'block';
        }

        function hideFileError() {
            const fileError = document.getElementById('fileError');
            fileError.style.display = 'none';
        }

        // REPLACE the form submission code in upload-cv.html (around line 350-500)

document.getElementById('uploadCVForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    // Validate required fields
    const fullName = document.getElementById('fullName').value;
    const email = document.getElementById('email').value;
    const phone = document.getElementById('phone').value;
    const location = document.getElementById('location').value;

    if (!fullName || !email || !phone || !location) {
        alert('Please fill in all required fields (marked with *)');
        return;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const isNewUser = urlParams.get('new_user') === 'true';
    const isEdit = urlParams.get('edit') === 'true';

    try {
        const submitBtn = document.getElementById('submitButton');
        const originalText = submitBtn.textContent;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
        submitBtn.disabled = true;

        let accessToken;
        if (isNewUser) {
            accessToken = localStorage.getItem('temp_access_token');
        } else {
            accessToken = localStorage.getItem('access_token');
        }

        if (!accessToken) {
            throw new Error('No authentication token found');
        }

        // Create FormData for file upload
        const formData = new FormData();
        formData.append('full_name', fullName);
        formData.append('email', email);
        formData.append('phone', phone);
        formData.append('location', location);
        formData.append('headline', document.getElementById('headline').value || '');
        formData.append('about', document.getElementById('about').value || '');
        formData.append('education', document.getElementById('education').value || '');
        formData.append('experience', document.getElementById('experience').value || '');
        
        // Add skills as JSON string
        const skillsValue = document.getElementById('skills').value;
        const skillsArray = skillsValue ? skillsValue.split(',').map(s => s.trim()).filter(s => s !== '') : [];
        formData.append('skills', JSON.stringify(skillsArray));
        
        // Add CV file if exists
        const cvFile = document.getElementById('cvFile').files[0];
        if (cvFile) {
            formData.append('cv_file', cvFile);
        }

        console.log('Sending profile data...');

        // Send to backend
        const response = await fetch(`${API_BASE_URL}/api/profile/create`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${accessToken}`
                // Don't set Content-Type - browser sets it automatically with boundary
            },
            body: formData
        });

        console.log('Response status:', response.status);

        if (response.ok) {
            const data = await response.json();
            console.log('Profile saved successfully:', data);

            if (isNewUser) {
                // For new users
                localStorage.setItem('access_token', accessToken);
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('currentUser', JSON.stringify(data));
                localStorage.setItem('userEmail', data.email);
                localStorage.setItem('userRole', 'job_seeker');
                localStorage.removeItem('temp_access_token');
                localStorage.removeItem('temp_user');

                const users = JSON.parse(localStorage.getItem('users') || '{}');
                users[data.email] = {
                    fullName: data.full_name,
                    email: data.email,
                    phone: data.phone,
                    location: data.location,
                    profileCompleted: true
                };
                localStorage.setItem('users', JSON.stringify(users));

                alert('✅ Profile completed successfully!');
                window.location.href = 'dashboard.html';

            } else if (isEdit) {
                // For profile edits
                localStorage.setItem('currentUser', JSON.stringify(data));
                alert('✅ Profile updated successfully!');
                window.location.href = 'profile.html';

            } else {
                // For existing users completing profile
                localStorage.setItem('currentUser', JSON.stringify(data));
                alert('✅ Profile completed successfully!');
                window.location.href = 'dashboard.html';
            }

        } else {
            const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
            console.error('Error response:', errorData);
            
            let errorMessage = 'Failed to save profile';
            if (errorData.detail) {
                if (Array.isArray(errorData.detail)) {
                    errorMessage = errorData.detail.map(err => err.msg || err).join(', ');
                } else {
                    errorMessage = errorData.detail;
                }
            }
            throw new Error(errorMessage);
        }

    } catch (error) {
        console.error('Profile save error:', error);
        alert('❌ Error: ' + error.message);

        const submitBtn = document.getElementById('submitButton');
        submitBtn.textContent = 'Complete Profile & Continue to Dashboard';
        submitBtn.disabled = false;
    }
});

        // Skip upload function
        async function skipUpload() {
            const urlParams = new URLSearchParams(window.location.search);
            const isNewUser = urlParams.get('new_user') === 'true';

            if (isNewUser) {
                if (confirm('Are you sure you want to skip profile completion? You will be redirected to dashboard but we recommend completing your profile for better job matches.')) {
                    try {
                        // For new users, we still need to activate their account
                        const tempToken = localStorage.getItem('temp_access_token');
                        const tempUser = JSON.parse(localStorage.getItem('temp_user') || '{}');

                        if (tempToken && tempUser) {
                            // Store permanent tokens
                            localStorage.setItem('access_token', tempToken);
                            localStorage.setItem('isLoggedIn', 'true');
                            localStorage.setItem('currentUser', JSON.stringify(tempUser));
                            localStorage.setItem('userEmail', tempUser.email);
                            localStorage.setItem('userRole', tempUser.role || 'job_seeker');

                            // Also add to users collection in local storage
                            const users = JSON.parse(localStorage.getItem('users') || '{}');
                            users[tempUser.email] = {
                                fullName: tempUser.full_name,
                                email: tempUser.email,
                                profileCompleted: false,
                                profileSkipped: true,
                                registeredAt: new Date().toISOString()
                            };
                            localStorage.setItem('users', JSON.stringify(users));

                            // Remove temp data
                            localStorage.removeItem('temp_access_token');
                            localStorage.removeItem('temp_user');

                            // Set profile skipped flag
                            localStorage.setItem('profileSkipped', 'true');

                            alert('You can complete your profile later. Redirecting to dashboard...');
                            window.location.href = 'dashboard.html';
                        } else {
                            alert('Error: Unable to process skip request. Please try registering again.');
                        }
                    } catch (error) {
                        console.error('Skip error:', error);
                        alert('Error during skip process. Please try again.');
                    }
                }
            } else {
                // Existing skip logic for non-new users
                if (confirm('Are you sure you want to skip profile completion? You can complete it later from your profile.')) {
                    localStorage.setItem('profileSkipped', 'true');
                    alert('You can complete your profile later. Redirecting to dashboard...');
                    window.location.href = 'dashboard.html';
                }
            }
        }
    </script>
</body>

</html>
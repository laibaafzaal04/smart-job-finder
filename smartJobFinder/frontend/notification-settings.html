<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Settings - Smart Job Finder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=EB+Garamond:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="assets/style.css">
    <style>
        .settings-card {
            border-left: 4px solid var(--primary);
        }
        .form-switch .form-check-input {
            width: 3rem;
            height: 1.5rem;
            cursor: pointer;
        }
        .setting-item {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.3s;
        }
        .setting-item:hover {
            background-color: #f8f9fa;
        }
        .setting-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-light bg-white shadow-sm px-4 py-3">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="dashboard.html">Smart<span style="color: var(--primary-dark);">Job</span>Finder</a>
        <div>
            <a href="dashboard.html" class="btn btn-outline-primary rounded-pill me-2">Dashboard</a>
            <a href="profile.html" class="btn btn-outline-primary rounded-pill me-2">Profile</a>
            <a href="index.html" class="btn btn-primary rounded-pill" onclick="logout()">Logout</a>
        </div>
    </div>
</nav>

<div class="container my-5">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="d-flex align-items-center mb-4">
                <a href="profile.html" class="btn btn-outline-secondary rounded-circle me-3">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div>
                    <h2 class="fw-bold mb-0" style="font-family: 'Playfair Display';">Notification Settings</h2>
                    <p class="text-muted mb-0">Manage how you receive updates from Smart Job Finder</p>
                </div>
            </div>

            <div class="card settings-card shadow-sm border-0 rounded-4 p-4">
                <form id="notificationSettingsForm">
                    
                    <!-- Email Notifications -->
                    <div class="setting-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-envelope text-primary me-2"></i>
                                    <h5 class="mb-0">Email Notifications</h5>
                                </div>
                                <p class="text-muted small mb-0">Receive important updates via email</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                            </div>
                        </div>
                    </div>

                    <!-- Job Alerts -->
                    <div class="setting-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-briefcase text-primary me-2"></i>
                                    <h5 class="mb-0">Job Alerts</h5>
                                </div>
                                <p class="text-muted small mb-0">Get notified when new jobs matching your profile are posted</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="jobAlerts" checked>
                            </div>
                        </div>
                    </div>

                    <!-- Application Updates -->
                    <div class="setting-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-paper-plane text-primary me-2"></i>
                                    <h5 class="mb-0">Application Updates</h5>
                                </div>
                                <p class="text-muted small mb-0">Receive updates when your application status changes</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="applicationUpdates" checked>
                            </div>
                        </div>
                    </div>

                    <!-- Marketing Emails -->
                    <div class="setting-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-bullhorn text-primary me-2"></i>
                                    <h5 class="mb-0">Marketing Emails</h5>
                                </div>
                                <p class="text-muted small mb-0">Tips, career advice, and Smart Job Finder news</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="marketingEmails">
                            </div>
                        </div>
                    </div>

                    <!-- Weekly Digest -->
                    <div class="setting-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-calendar-week text-primary me-2"></i>
                                    <h5 class="mb-0">Weekly Digest</h5>
                                </div>
                                <p class="text-muted small mb-0">Summary of your activity and new opportunities</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="weeklyDigest">
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 d-flex gap-3">
                        <button type="submit" class="btn btn-primary rounded-pill px-4">
                            <i class="fas fa-save me-2"></i>Save Preferences
                        </button>
                        <a href="profile.html" class="btn btn-outline-secondary rounded-pill px-4">Cancel</a>
                    </div>
                </form>
            </div>

            <!-- Additional Info Card -->
            <div class="card border-0 shadow-sm rounded-4 p-4 mt-4">
                <h5 class="fw-bold mb-3"><i class="fas fa-info-circle text-primary me-2"></i>About Notifications</h5>
                <ul class="mb-0">
                    <li class="mb-2"><strong>Email Notifications:</strong> Critical account and security updates (cannot be disabled)</li>
                    <li class="mb-2"><strong>Job Alerts:</strong> Sent daily when new matching jobs are posted</li>
                    <li class="mb-2"><strong>Application Updates:</strong> Instant notifications about your applications</li>
                    <li class="mb-0"><strong>Weekly Digest:</strong> Every Monday at 9 AM</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
const API_BASE_URL = "http://localhost:8000";

window.addEventListener('load', async function() {
    // Check if logged in
    const isLoggedIn = localStorage.getItem('isLoggedIn');
    if (!isLoggedIn) {
        window.location.href = 'login.html';
        return;
    }

    // Load current preferences
    await loadPreferences();
});

async function loadPreferences() {
    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) return;

    try {
        // Get user data
        const response = await fetch(`${API_BASE_URL}/api/auth/me`, {
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Accept': 'application/json'
            }
        });

        if (response.ok) {
            const userData = await response.json();
            
            // Load preferences from localStorage or defaults
            const preferences = JSON.parse(localStorage.getItem('notificationPreferences') || '{}');
            
            document.getElementById('emailNotifications').checked = preferences.email_notifications !== false;
            document.getElementById('jobAlerts').checked = preferences.job_alerts !== false;
            document.getElementById('applicationUpdates').checked = preferences.application_updates !== false;
            document.getElementById('marketingEmails').checked = preferences.marketing_emails || false;
            document.getElementById('weeklyDigest').checked = preferences.weekly_digest || false;
        }
    } catch (error) {
        console.error('Error loading preferences:', error);
    }
}

document.getElementById('notificationSettingsForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
        alert('Please login to save preferences');
        window.location.href = 'login.html';
        return;
    }

    const preferences = {
        email_notifications: document.getElementById('emailNotifications').checked,
        job_alerts: document.getElementById('jobAlerts').checked,
        application_updates: document.getElementById('applicationUpdates').checked,
        marketing_emails: document.getElementById('marketingEmails').checked,
        weekly_digest: document.getElementById('weeklyDigest').checked,
        // Add user_id from localStorage for compatibility
        user_id: JSON.parse(localStorage.getItem('currentUser') || '{}').id
    };

    try {
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
        submitBtn.disabled = true;

        // First try the notification preferences endpoint
        const response = await fetch(`${API_BASE_URL}/api/user/notification-preferences`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`,
                'Accept': 'application/json'
            },
            body: JSON.stringify(preferences)
        });

        if (response.ok) {
            const data = await response.json();
            
            // Save to localStorage for quick access
            localStorage.setItem('notificationPreferences', JSON.stringify(preferences));
            
            showToast('✅ Notification preferences saved successfully!', 'success');
        } else if (response.status === 404 || response.status === 422) {
            // If notification endpoint doesn't exist or has issues, try user preferences endpoint
            console.log('Notification endpoint failed, trying user preferences...');
            
            // Try alternative endpoint - update user preferences
            const updateResponse = await fetch(`${API_BASE_URL}/api/user/update-preferences`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    notification_settings: preferences
                })
            });

            if (updateResponse.ok) {
                const updateData = await updateResponse.json();
                localStorage.setItem('notificationPreferences', JSON.stringify(preferences));
                showToast('✅ Notification preferences saved successfully!', 'success');
            } else {
                // If all API calls fail, save to localStorage only
                localStorage.setItem('notificationPreferences', JSON.stringify(preferences));
                showToast('✅ Preferences saved locally!', 'info');
            }
        } else {
            throw new Error('Failed to save preferences');
        }

        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;

    } catch (error) {
        console.error('Error saving preferences:', error);
        
        // Save to localStorage as fallback
        localStorage.setItem('notificationPreferences', JSON.stringify(preferences));
        
        showToast('⚠️ Preferences saved locally. Some features may be limited.', 'warning');
        
        const submitBtn = document.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Preferences';
        submitBtn.disabled = false;
    }
});

function showToast(message, type = 'info') {
    // Remove any existing toast
    const existingToast = document.querySelector('.notification-toast');
    if (existingToast) existingToast.remove();
    
    // Create new toast
    const toast = document.createElement('div');
    toast.className = `notification-toast alert alert-${type} position-fixed`;
    toast.style.cssText = 'top:20px;right:20px;z-index:9999;min-width:300px;animation:slideInRight 0.5s;';
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : type === 'warning' ? 'exclamation-triangle' : 'info'}-circle me-2"></i>
        ${message}
    `;
    document.body.appendChild(toast);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.5s';
        setTimeout(() => toast.remove(), 500);
    }, 3000);
}

function logout() {
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('userEmail');
    localStorage.removeItem('currentUser');
    localStorage.removeItem('access_token');
    window.location.href = 'index.html';
}
</script>
</body>
</html>